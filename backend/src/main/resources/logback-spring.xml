<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    
    <!-- =================================================================== -->
    <!-- H2H Two-Tier Logging Configuration                                 -->
    <!-- Tier 1: APPLICATION LOGS (files only) - Infrastructure events     -->
    <!-- Tier 2: TRANSACTIONAL LOGS (files + database) - Business events   -->
    <!-- =================================================================== -->
    
    <!-- TIER 1: APPLICATION LOGS - Files Only -->
    
    <!-- Console appender for development -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level [%X{correlationId:-}] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- APPLICATION logs - Infrastructure, startup, configuration, debug -->
    <appender name="APPLICATION_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH:-logs}/application.log</file>
        <filter class="com.integrixs.backend.logging.ApplicationLogFilter"/>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH:-logs}/backup/application.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- Error file appender for application errors -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH:-logs}/h2h-backend-error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH:-logs}/backup/h2h-backend-error.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>60</maxHistory>
            <totalSizeCap>2GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{correlationId:-}] [%X{userId:-}] %logger{36} - %msg%n%ex</pattern>
        </encoder>
    </appender>
    
    <!-- TIER 2: TRANSACTIONAL LOGS - Files + Database -->
    
    <!-- TRANSACTIONAL logs - Authentication, file processing, adapter execution -->
    <appender name="TRANSACTION_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH:-logs}/transactions.log</file>
        <filter class="com.integrixs.backend.logging.TransactionalLogFilter"/>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH:-logs}/backup/transactions.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>90</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{correlationId:-}] [%X{username:-}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- TRANSACTIONAL database appender - Stores business events in transaction_logs table -->
    <appender name="TRANSACTION_DB" class="com.integrixs.backend.logging.TransactionLogAppender">
        <filter class="com.integrixs.backend.logging.TransactionalLogFilter"/>
    </appender>
    
    <!-- Legacy appenders for backward compatibility -->
    
    <!-- Adapter execution file appender -->
    <appender name="ADAPTER_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH:-logs}/h2h-adapter-execution.log</file>
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator class="ch.qos.logback.classic.boolex.OnMarkerEvaluator">
                <marker>ADAPTER_EXECUTION</marker>
            </evaluator>
            <onMismatch>DENY</onMismatch>
            <onMatch>ACCEPT</onMatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH:-logs}/backup/h2h-adapter-execution.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{correlationId:-}] [%X{adapterId:-}] [%X{adapterName:-}] [%X{executionId:-}] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- Flow execution file appender -->
    <appender name="FLOW_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH:-logs}/h2h-flow-execution.log</file>
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator class="ch.qos.logback.classic.boolex.OnMarkerEvaluator">
                <marker>FLOW_EXECUTION</marker>
            </evaluator>
            <onMismatch>DENY</onMismatch>
            <onMatch>ACCEPT</onMatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH:-logs}/backup/h2h-flow-execution.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="com.integrixs.backend.logging.BusinessFriendlyLayout"/>
        </encoder>
    </appender>
    
    <!-- Business-friendly flow logging appender -->
    <appender name="BUSINESS_FLOW_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH:-logs}/h2h-business-flow.log</file>
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>INFO</level>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH:-logs}/backup/h2h-business-flow.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- Legacy database appender (for backward compatibility with existing system_logs) -->
    <appender name="DATABASE" class="com.integrixs.backend.logging.DatabaseLogAppender">
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>INFO</level>
        </filter>
    </appender>
    
    <!-- =================================================================== -->
    <!-- PROFILE-SPECIFIC CONFIGURATIONS                                    -->
    <!-- =================================================================== -->
    
    <!-- Development profile configuration -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="APPLICATION_FILE"/>
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
            <appender-ref ref="ERROR_FILE"/>
            <appender-ref ref="ADAPTER_FILE"/>
            <appender-ref ref="FLOW_FILE"/>
            <appender-ref ref="DATABASE"/>
        </root>
        
        <!-- Framework levels -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.apache" level="WARN"/>
        <logger name="org.hibernate" level="WARN"/>
        <logger name="com.zaxxer.hikari" level="INFO"/>
        
        <!-- Application logging -->
        <logger name="com.integrixs" level="DEBUG"/>
        
        <!-- Authentication logging - goes to TRANSACTIONAL tier -->
        <logger name="com.integrixs.backend.logging.H2HAuthenticationLogger" level="DEBUG" additivity="false">
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
            <appender-ref ref="CONSOLE"/>
        </logger>
        
        <!-- Security event listener - goes to TRANSACTIONAL tier -->
        <logger name="com.integrixs.backend.security.AuthenticationEventListener" level="DEBUG" additivity="false">
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
            <appender-ref ref="CONSOLE"/>
        </logger>
        
        <!-- Transaction log service - goes to APPLICATION tier only (avoid recursion) -->
        <logger name="com.integrixs.core.service.TransactionLogService" level="DEBUG" additivity="false">
            <appender-ref ref="APPLICATION_FILE"/>
            <appender-ref ref="CONSOLE"/>
        </logger>
        
        <!-- Adapter execution - dual logging for backward compatibility -->
        <logger name="com.integrixs.adapters" level="DEBUG" additivity="false">
            <appender-ref ref="ADAPTER_FILE"/>
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
            <appender-ref ref="CONSOLE"/>
        </logger>
        
        <!-- Flow execution - dual logging for backward compatibility -->
        <logger name="com.integrixs.flows" level="DEBUG" additivity="false">
            <appender-ref ref="FLOW_FILE"/>
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
            <appender-ref ref="CONSOLE"/>
        </logger>
    </springProfile>
    
    <!-- Test profile configuration -->
    <springProfile name="test">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="APPLICATION_FILE"/>
        </root>
        
        <logger name="com.integrixs" level="DEBUG"/>
        <logger name="org.springframework" level="WARN"/>
        
        <!-- Authentication logging in test -->
        <logger name="com.integrixs.backend.logging.H2HAuthenticationLogger" level="DEBUG" additivity="false">
            <appender-ref ref="CONSOLE"/>
        </logger>
    </springProfile>
    
    <!-- Production profile configuration -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="APPLICATION_FILE"/>
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
            <appender-ref ref="ERROR_FILE"/>
            <appender-ref ref="ADAPTER_FILE"/>
            <appender-ref ref="FLOW_FILE"/>
        </root>
        
        <!-- Framework levels -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.apache" level="WARN"/>
        <logger name="org.hibernate" level="WARN"/>
        <logger name="com.zaxxer.hikari" level="WARN"/>
        
        <!-- Application levels -->
        <logger name="com.integrixs" level="INFO"/>
        
        <!-- Authentication logging - TRANSACTIONAL tier only -->
        <logger name="com.integrixs.backend.logging.H2HAuthenticationLogger" level="INFO" additivity="false">
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
        </logger>
        
        <!-- Security event listener - TRANSACTIONAL tier only -->
        <logger name="com.integrixs.backend.security.AuthenticationEventListener" level="INFO" additivity="false">
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
        </logger>
        
        <!-- Transaction log service - APPLICATION tier only -->
        <logger name="com.integrixs.core.service.TransactionLogService" level="INFO" additivity="false">
            <appender-ref ref="APPLICATION_FILE"/>
        </logger>
        
        <!-- Adapter execution -->
        <logger name="com.integrixs.adapters" level="INFO" additivity="false">
            <appender-ref ref="ADAPTER_FILE"/>
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
        </logger>
        
        <!-- Flow execution -->
        <logger name="com.integrixs.flows" level="INFO" additivity="false">
            <appender-ref ref="FLOW_FILE"/>
            <appender-ref ref="TRANSACTION_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
        </logger>
        
        <!-- Business-friendly flow logger -->
        <logger name="BUSINESS_FLOW" level="INFO" additivity="false">
            <appender-ref ref="BUSINESS_FLOW_FILE"/>
        </logger>
    </springProfile>
    
    <!-- Docker profile configuration -->
    <springProfile name="docker">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ERROR_FILE"/>
            <appender-ref ref="TRANSACTION_DB"/>
        </root>
        
        <logger name="com.integrixs" level="INFO"/>
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.apache" level="WARN"/>
        <logger name="org.hibernate" level="WARN"/>
        
        <!-- Authentication logging in Docker -->
        <logger name="com.integrixs.backend.logging.H2HAuthenticationLogger" level="INFO" additivity="false">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="TRANSACTION_DB"/>
        </logger>
    </springProfile>
    
    <!-- =================================================================== -->
    <!-- COMPONENT-SPECIFIC LOGGER CONFIGURATIONS                           -->
    <!-- =================================================================== -->
    
    <!-- Security and authentication logging -->
    <logger name="org.springframework.security" level="DEBUG" additivity="true"/>
    <logger name="com.integrixs.backend.security" level="DEBUG" additivity="true"/>
    
    <!-- Database and repository logging -->
    <logger name="org.springframework.jdbc" level="INFO" additivity="true"/>
    <logger name="com.integrixs.backend.repository" level="DEBUG" additivity="true"/>
    <logger name="com.integrixs.core.repository" level="DEBUG" additivity="true"/>
    
    <!-- Performance monitoring -->
    <logger name="com.integrixs.backend.aspect" level="INFO" additivity="true"/>
    
    <!-- Silence some noisy loggers -->
    <logger name="org.springframework.boot.autoconfigure" level="ERROR"/>
    <logger name="org.springframework.boot.diagnostics" level="ERROR"/>
    <logger name="org.apache.catalina.startup" level="INFO"/>
    <logger name="org.apache.coyote.http11.Http11Protocol" level="INFO"/>
    
</configuration>